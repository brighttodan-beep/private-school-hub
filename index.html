<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private School Hub – Attendance, Grades, Fees & Parent Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f3f4ff 45%, #f9fafb 100%);
      color: #0f172a;
      margin: 0;
      padding: 0;
    }
    .page { max-width: 1000px; margin: 0 auto; padding: 16px; }
    header { padding: 8px 0 4px; }
    .app-title { font-size: 1.6rem; font-weight: 800; color: #1d4ed8; }
    .app-sub { font-size: 0.9rem; color: #4b5563; margin-top: 2px; }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; border-radius: 999px; font-size: 0.75rem;
      background: rgba(37,99,235,0.08); color: #1d4ed8;
      margin-top: 6px; border: 1px solid rgba(37,99,235,0.2);
    }
    .auth-bar {
      margin-top: 10px; padding: 8px 12px; border-radius: 999px;
      background: #eff6ff; border: 1px solid #bfdbfe;
      display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
      font-size: 0.8rem; color: #1e40af;
    }
    .auth-status { flex: 1; min-width: 150px; }
    .nav {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin: 14px 0 16px;
    }
    .nav button {
      padding: 8px 16px; border-radius: 999px;
      border: 1px solid #cbd5f5; background: #fff;
      color: #1f2937; font-size: 0.9rem; cursor: pointer;
      transition: 0.15s;
    }
    .nav button:hover:not(.active):not(.disabled) { background: #ebf2ff; }
    .nav button.active {
      background: #2563eb; color: #fff; border-color: #2563eb;
      font-weight: 600; box-shadow: 0 4px 12px rgba(37,99,235,0.35);
    }
    .nav button.disabled { opacity: 0.5; cursor: not-allowed; }
    .card {
      background: #ffffff; border-radius: 14px; padding: 16px;
      margin-bottom: 14px; border: 1px solid #e5e7eb;
      box-shadow: 0 6px 20px rgba(15,23,42,0.08);
    }
    .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 10px; color: #111827; }
    label {
      display: block; font-size: 0.8rem; color: #4b5563; margin-bottom: 6px;
    }
    input, textarea, select {
      width: 100%; padding: 9px 10px; border-radius: 10px;
      border: 1px solid #d1d5db; background: #ffffff;
      color: #111827; font-size: 0.9rem; transition: 0.15s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.25); background: #f9fafb;
    }
    textarea { min-height: 80px; resize: vertical; }
    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .col { flex: 1; min-width: 220px; }
    .btn-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    button {
      border: none; border-radius: 999px; padding: 9px 16px;
      font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.15s;
    }
    button.primary { background: #2563eb; color: #ffffff; }
    button.primary:hover { background: #1d4ed8; }
    button.secondary {
      background: #eff6ff; color: #1f2937; border: 1px solid #cbd5f5;
    }
    button.secondary:hover { background: #e0edff; }
    button.danger { background: #ef4444; color: #ffffff; }
    button.danger:hover { background: #dc2626; }
    button.small { font-size: 0.75rem; padding: 6px 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th, td { padding: 8px; border-bottom: 1px solid #e5e7eb; }
    th { color: #6b7280; font-weight: 500; background: #f9fafb; }
    .status-select { width: auto; padding: 6px 10px; border-radius: 8px; }
    .grade-input, .fee-input { width: 90px; padding: 6px; }
    .summary { font-size: 0.8rem; color: #6b7280; margin-top: 8px; }
    .footer {
      text-align: center; font-size: 0.75rem;
      color: #6b7280; margin-top: 20px; padding-bottom: 8px;
    }
    .auth-card { margin-top: 10px; }
    .auth-card small { font-size: 0.75rem; color: #6b7280; }
    .auth-message { font-size: 0.8rem; margin-top: 6px; min-height: 1.1em; }
    .auth-message.error { color: #b91c1c; }
    .auth-message.success { color: #15803d; }
    .lock-screen {
      position: fixed; inset: 0; background: rgba(15,23,42,0.2);
      display: flex; align-items: center; justify-content: center;
      z-index: 50; backdrop-filter: blur(4px);
    }
    .lock-card {
      background: #ffffff; border-radius: 16px; padding: 20px 16px;
      border: 1px solid #d1d5db; box-shadow: 0 16px 40px rgba(15,23,42,0.2);
      max-width: 320px; width: 100%; text-align: center;
    }
    .lock-card h2 { margin: 0 0 8px; font-size: 1.2rem; color: #111827; }
    .lock-card p { margin: 6px 0 12px; font-size: 0.85rem; color: #4b5563; }
    .lock-card input {
      width: 100%; text-align: center; letter-spacing: 0.3em;
      font-size: 1.2rem; padding: 10px; border-radius: 999px;
      border: 1px solid #d1d5db; background: #f9fafb; color: #111827;
      margin-bottom: 12px;
    }
    .lock-card input:focus {
      outline: none; border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.25); background: #ffffff;
    }
    .lock-buttons { display: flex; gap: 10px; justify-content: center; margin-bottom: 6px; flex-wrap: wrap; }
    .lock-message { font-size: 0.85rem; color: #b45309; min-height: 1.1em; }
    @media (max-width: 600px) { .page { padding: 12px; } }
  </style>
</head>
<body>
  <!-- PIN LOCK OVERLAY -->
  <div id="lockScreen" class="lock-screen">
    <div class="lock-card">
      <h2 id="lockTitle">Private School Hub – PIN</h2>
      <p id="lockSubtitle">Set a 4-digit PIN to protect school data on this device.</p>
      <input id="lockPinInput" type="password" maxlength="4" inputmode="numeric" />
      <div class="lock-buttons">
        <button id="lockPrimaryBtn" class="primary">Save PIN</button>
        <button id="lockResetBtn" class="danger small" style="display:none;">Reset data & PIN</button>
      </div>
      <p id="lockMessage" class="lock-message"></p>
    </div>
  </div>

  <div class="page">
    <header>
      <div class="app-title">Private School Hub</div>
      <div class="app-sub">
        All-in-one school app – Attendance • Grades • Fees • Parent Portal (v4 – Local + Auth + Cloud + Backup)
      </div>
      <div class="badge">Developed by Bright TODAN</div>

      <!-- AUTH BAR -->
      <div id="authBar" class="auth-bar">
        <div id="authStatus" class="auth-status">Not signed in</div>
        <button id="showAuthFormBtn" class="secondary small">Sign in / Sign up</button>
        <button id="logoutBtn" class="secondary small" style="display:none;">Log out</button>
      </div>

      <!-- AUTH FORM -->
      <div id="authForm" class="card auth-card" style="display:none;">
        <div class="card-title">User login / registration</div>
        <div class="row">
          <div class="col">
            <label for="authEmail">Email</label>
            <input id="authEmail" type="email" placeholder="example@school.com" />
          </div>
          <div class="col">
            <label for="authPassword">Password</label>
            <input id="authPassword" type="password" placeholder="At least 6 characters" />
          </div>
        </div>
        <div class="btn-row">
          <button id="authSignInBtn" class="primary small">Sign in</button>
          <button id="authSignUpBtn" class="secondary small">Sign up (create account)</button>
        </div>
        <div id="authMessage" class="auth-message"></div>
        <small>
          Login uses Firebase Authentication. Class lists, attendance and fees can sync to the cloud when you are signed in.
          Grades still use local storage for now.
        </small>
      </div>

            <div class="nav">
        <button id="navAttendance" class="active">Attendance</button>
        <button id="navGrades">Grades</button>
        <button id="navFees">School Fees</button>
        <button id="navParent">Parent Portal</button>
        <button id="navDashboard">Headmaster</button>
      </div>

    </header>

    <!-- ATTENDANCE MODULE -->
    <section id="attendance">
      <div class="card">
        <div class="card-title">Class & Date</div>
        <div class="row">
          <div class="col">
            <label for="className">Class</label>
            <select id="className">
              <option value="">-- Select class --</option>
              <optgroup label="Primary">
                <option value="Primary 1">Primary 1</option>
                <option value="Primary 2">Primary 2</option>
                <option value="Primary 3">Primary 3</option>
                <option value="Primary 4">Primary 4</option>
                <option value="Primary 5">Primary 5</option>
                <option value="Primary 6">Primary 6</option>
              </optgroup>
              <optgroup label="JHS">
                <option value="JHS 1">JHS 1</option>
                <option value="JHS 2">JHS 2</option>
                <option value="JHS 3">JHS 3</option>
              </optgroup>
              <optgroup label="SHS">
                <option value="SHS 1">SHS 1</option>
                <option value="SHS 2">SHS 2</option>
                <option value="SHS 3">SHS 3</option>
              </optgroup>
            </select>
          </div>
          <div class="col">
            <label for="attDate">Date</label>
            <input id="attDate" type="date" />
          </div>
        </div>
        <div class="btn-row">
          <button id="loadClassBtn" class="secondary small">Load class list</button>
          <button id="clearClassBtn" class="danger small">Delete class list from this device</button>
        </div>
        <div class="summary" id="classInfo"></div>
      </div>

      <div class="card">
        <div class="card-title">Student list for this class</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          Type or paste student names, one per line. Example:<br/>
          <em>1. Kossi Mawuli<br/>2. Ama Akosua<br/>3. John Mensah</em><br/>
          Numbers are optional, they will be cleaned automatically.
        </p>
        <textarea id="studentsRaw" placeholder="One student per line..."></textarea>
        <div class="btn-row">
          <button id="saveClassBtn" class="primary">Save class list (local + cloud)</button>
        </div>
        <div class="summary" id="studentsCountInfo"></div>
      </div>

      <div class="card">
        <div class="card-title">Today’s attendance</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          After saving the class list, you will see all students below with a status:
          <strong>Present</strong>, <strong>Absent</strong>, or <strong>Late</strong>.<br/>
          When you are signed in, attendance is also saved to the cloud.
        </p>
        <div style="overflow-x:auto;">
          <table id="attendanceTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Student name</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="btn-row">
          <button id="saveAttendanceBtn" class="primary">Save attendance for this date</button>
          <button id="loadAttendanceBtn" class="secondary small">Load attendance for this date</button>
          <button id="exportAttendanceBtn" class="secondary small">Export CSV for this date</button>
        </div>
        <div class="summary" id="attendanceSummary"></div>
      </div>
    </section>

    <!-- GRADES MODULE -->
    <section id="grades" style="display:none;">
      <div class="card">
        <div class="card-title">Class, Subject & Assessment</div>
        <div class="row">
          <div class="col">
            <label for="gradesClassName">Class</label>
            <select id="gradesClassName">
              <option value="">-- Select class --</option>
              <optgroup label="Primary">
                <option value="Primary 1">Primary 1</option>
                <option value="Primary 2">Primary 2</option>
                <option value="Primary 3">Primary 3</option>
                <option value="Primary 4">Primary 4</option>
                <option value="Primary 5">Primary 5</option>
                <option value="Primary 6">Primary 6</option>
              </optgroup>
              <optgroup label="JHS">
                <option value="JHS 1">JHS 1</option>
                <option value="JHS 2">JHS 2</option>
                <option value="JHS 3">JHS 3</option>
              </optgroup>
              <optgroup label="SHS">
                <option value="SHS 1">SHS 1</option>
                <option value="SHS 2">SHS 2</option>
                <option value="SHS 3">SHS 3</option>
              </optgroup>
            </select>
          </div>
          <div class="col">
            <label for="subjectName">Subject</label>
            <input id="subjectName" type="text" placeholder="Example: Mathematics" />
          </div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label for="assessmentName">Assessment name</label>
            <input id="assessmentName" type="text" placeholder="Example: Test 1, Midterm, Exam Term 1" />
          </div>
          <div class="col">
            <label for="maxScore">Maximum score (optional)</label>
            <input id="maxScore" type="number" min="0" placeholder="Example: 20 or 100" />
          </div>
        </div>
        <div class="btn-row">
          <button id="gradesLoadClassBtn" class="secondary small">Load class list for grades</button>
          <button id="gradesLoadGradesBtn" class="secondary small">Load saved grades</button>
          <button id="gradesClearScoresBtn" class="danger small">Clear scores (keep students)</button>
        </div>
        <div class="summary" id="gradesInfo"></div>
      </div>

      <div class="card">
        <div class="card-title">Scores table</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          After loading the class list, you will see all students with an empty score field.
          Enter scores and save them for this subject & assessment.
        </p>
        <div style="overflow-x:auto;">
          <table id="gradesTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Student name</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="btn-row">
          <button id="gradesSaveBtn" class="primary">Save grades</button>
          <button id="gradesExportBtn" class="secondary small">Export grades CSV</button>
        </div>
        <div class="summary" id="gradesSummary"></div>
      </div>
    </section>

    <!-- FEES MODULE -->
    <section id="fees" style="display:none;">
      <div class="card">
        <div class="card-title">Class & Fee Period</div>
        <div class="row">
          <div class="col">
            <label for="feesClassName">Class</label>
            <select id="feesClassName">
              <option value="">-- Select class --</option>
              <optgroup label="Primary">
                <option value="Primary 1">Primary 1</option>
                <option value="Primary 2">Primary 2</option>
                <option value="Primary 3">Primary 3</option>
                <option value="Primary 4">Primary 4</option>
                <option value="Primary 5">Primary 5</option>
                <option value="Primary 6">Primary 6</option>
              </optgroup>
              <optgroup label="JHS">
                <option value="JHS 1">JHS 1</option>
                <option value="JHS 2">JHS 2</option>
                <option value="JHS 3">JHS 3</option>
              </optgroup>
              <optgroup label="SHS">
                <option value="SHS 1">SHS 1</option>
                <option value="SHS 2">SHS 2</option>
                <option value="SHS 3">SHS 3</option>
              </optgroup>
            </select>
          </div>
          <div class="col">
            <label for="feePeriod">Fee period / term</label>
            <input id="feePeriod" type="text" placeholder="Example: 2025-2026 Term 1" />
          </div>
        </div>
        <div class="btn-row">
          <button id="feesLoadClassBtn" class="secondary small">Load class list for fees</button>
          <button id="feesLoadDataBtn" class="secondary small">Load saved fees for this period</button>
          <button id="feesClearAmountsBtn" class="danger small">Clear amounts (keep students)</button>
        </div>
        <div class="summary" id="feesInfo"></div>
      </div>

      <div class="card">
        <div class="card-title">School fees table</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          After loading the class list, set the total school fees and amount paid for each student.
          Remaining balance is calculated automatically.
          When you are signed in, fees are stored in the cloud plus locally.
        </p>
        <div style="overflow-x:auto;">
          <table id="feesTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Student name</th>
                <th>Total fee</th>
                <th>Paid</th>
                <th>Remaining</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="btn-row">
          <button id="feesSaveBtn" class="primary">Save fees</button>
          <button id="feesExportBtn" class="secondary small">Export fees CSV</button>
        </div>
        <div class="summary" id="feesSummary"></div>
      </div>
    </section>

    <!-- PARENT PORTAL MODULE -->
    <section id="parent" style="display:none;">
      <div class="card">
        <div class="card-title">Parent Portal – Select student</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          This view is read-only. It summarizes attendance, grades and fees for one student,
          based on data already saved on this device (and synced from cloud when loaded).
        </p>
        <div class="row">
          <div class="col">
            <label for="parentClassName">Class</label>
            <select id="parentClassName">
              <option value="">-- Select class --</option>
              <optgroup label="Primary">
                <option value="Primary 1">Primary 1</option>
                <option value="Primary 2">Primary 2</option>
                <option value="Primary 3">Primary 3</option>
                <option value="Primary 4">Primary 4</option>
                <option value="Primary 5">Primary 5</option>
                <option value="Primary 6">Primary 6</option>
              </optgroup>
              <optgroup label="JHS">
                <option value="JHS 1">JHS 1</option>
                <option value="JHS 2">JHS 2</option>
                <option value="JHS 3">JHS 3</option>
              </optgroup>
              <optgroup label="SHS">
                <option value="SHS 1">SHS 1</option>
                <option value="SHS 2">SHS 2</option>
                <option value="SHS 3">SHS 3</option>
              </optgroup>
            </select>
          </div>
          <div class="col">
            <label for="parentStudentSelect">Student</label>
            <select id="parentStudentSelect">
              <option value="">-- Load class students first --</option>
            </select>
          </div>
        </div>
        <div class="btn-row">
          <button id="parentLoadClassBtn" class="secondary small">Load class students</button>
          <button id="parentLoadDataBtn" class="primary small">Load student data</button>
        </div>
        <div class="summary" id="parentInfo"></div>
      </div>

      <div class="card">
        <div class="card-title">Student summary (read-only)</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          Use this section when meeting a parent. It shows only what has already been recorded
          in Attendance, Grades and Fees modules on this device or synced for this browser.
        </p>

        <h4 style="font-size:0.9rem; margin-top:4px;">Attendance history</h4>
        <div id="parentAttendanceList" style="font-size:0.8rem;"></div>

        <h4 style="font-size:0.9rem; margin-top:10px;">Grades</h4>
        <div id="parentGradesList" style="font-size:0.8rem;"></div>

        <h4 style="font-size:0.9rem; margin-top:10px;">School fees</h4>
        <div id="parentFeesList" style="font-size:0.8rem;"></div>
      </div>

      <div class="summary">
        Note: Parent Portal works offline and only shows data stored in this browser.
        For backup, export CSV files regularly from each module.
      </div>
    </section>
    <!-- HEADMASTER DASHBOARD MODULE -->
    <section id="dashboard" style="display:none;">
      <div class="card">
        <div class="card-title">Headmaster Overview</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          This summary is based on data stored in this browser:
          class lists, attendance, grades and fees.<br/>
          Use it to see a quick overview before a meeting or presentation.
        </p>
        <div id="dashboardContent" style="font-size:0.8rem;"></div>
      </div>
    </section>

    <!-- BACKUP & RESTORE SECTION -->
    <section id="backupSection">
      <div class="card">
        <div class="card-title">Backup & Restore (Device data)</div>
        <p style="font-size:0.8rem; color:#4b5563; margin-top:0;">
          This backup includes only Private School Hub data saved in this browser:
          class lists, attendance, grades, fees and PIN.<br/>
          Use it when changing computer or browser.
        </p>
        <div class="btn-row">
          <button id="backupDownloadBtn" class="secondary small">
            Download backup (.json)
          </button>
          <button id="backupRestoreBtn" class="primary small">
            Restore from backup file
          </button>
          <input id="backupFileInput" type="file" accept=".json,application/json" style="display:none;" />
        </div>
        <div class="summary" id="backupInfo"></div>
      </div>
    </section>

    <div class="footer">
      Data is stored locally in this browser, and class lists, attendance and fees are backed up in the cloud when you are signed in.<br/>
      Private School Hub – by Bright TODAN.
    </div>
  </div>

  <!-- Firebase CDN (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBL6zBTICYR64TuNSAO19s1iI6POAm0ZQU",
      authDomain: "private-school-hub.firebaseapp.com",
      projectId: "private-school-hub",
      storageBucket: "private-school-hub.firebasestorage.app",
      messagingSenderId: "1042069826904",
      appId: "1:1042069826904:web:67d1612f78ff440fcb092d",
      measurementId: "G-5TMPV3Q8ZC"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const CLOUD_CLASSES_COLLECTION = "classLists";
    const CLOUD_ATTENDANCE_COLLECTION = "attendanceRecords";
    const CLOUD_FEES_COLLECTION = "feesRecords";

    function normalizeKey(str) {
      return str.toLowerCase().trim().replace(/\s+/g, "_");
    }
    function getClassDocId(className) { return normalizeKey(className); }
    function getAttendanceDocId(className, dateISO) {
      return normalizeKey(className) + "__" + dateISO;
    }
    function getFeesDocId(className, period) {
      return normalizeKey(className) + "__" + normalizeKey(period);
    }

    async function saveClassListToCloud(className, students) {
      if (!auth.currentUser) return { ok: false, reason: "not_logged_in" };
      const uid = auth.currentUser.uid;
      const email = auth.currentUser.email || "";
      const docId = getClassDocId(className);
      try {
        await db.collection(CLOUD_CLASSES_COLLECTION).doc(docId).set({
          className, students,
          ownerUid: uid,
          updatedBy: email || uid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        return { ok: true };
      } catch (error) {
        console.error("Cloud save class error:", error);
        return { ok: false, error };
      }
    }

    async function loadClassListFromCloud(className) {
      if (!auth.currentUser) return { ok: false, reason: "not_logged_in" };
      const docId = getClassDocId(className);
      try {
        const snap = await db.collection(CLOUD_CLASSES_COLLECTION).doc(docId).get();
        if (!snap.exists) return { ok: false, reason: "not_found" };
        const data = snap.data();
        const students = Array.isArray(data.students) ? data.students : [];
        return { ok: true, students };
      } catch (error) {
        console.error("Cloud load class error:", error);
        return { ok: false, error };
      }
    }

    async function saveAttendanceToCloud(className, dateISO, attendance) {
      if (!auth.currentUser) return { ok: false, reason: "not_logged_in" };
      const uid = auth.currentUser.uid;
      const email = auth.currentUser.email || "";
      const docId = getAttendanceDocId(className, dateISO);
      try {
        await db.collection(CLOUD_ATTENDANCE_COLLECTION).doc(docId).set({
          className, date: dateISO, attendance,
          ownerUid: uid,
          updatedBy: email || uid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        return { ok: true };
      } catch (error) {
        console.error("Cloud save attendance error:", error);
        return { ok: false, error };
      }
    }

    async function loadAttendanceFromCloud(className, dateISO) {
      if (!auth.currentUser) return { ok: false, reason: "not_logged_in" };
      const docId = getAttendanceDocId(className, dateISO);
      try {
        const snap = await db.collection(CLOUD_ATTENDANCE_COLLECTION).doc(docId).get();
        if (!snap.exists) return { ok: false, reason: "not_found" };
        const data = snap.data();
        const attendance = Array.isArray(data.attendance) ? data.attendance : [];
        return { ok: true, attendance };
      } catch (error) {
        console.error("Cloud load attendance error:", error);
        return { ok: false, error };
      }
    }

    async function saveFeesToCloud(className, period, fees) {
      if (!auth.currentUser) return { ok: false, reason: "not_logged_in" };
      const uid = auth.currentUser.uid;
      const email = auth.currentUser.email || "";
      const docId = getFeesDocId(className, period);
      try {
        await db.collection(CLOUD_FEES_COLLECTION).doc(docId).set({
          className, period, fees,
          ownerUid: uid,
          updatedBy: email || uid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        return { ok: true };
      } catch (error) {
        console.error("Cloud save fees error:", error);
        return { ok: false, error };
      }
    }

    async function loadFeesFromCloud(className, period) {
      if (!auth.currentUser) return { ok: false, reason: "not_logged_in" };
      const docId = getFeesDocId(className, period);
      try {
        const snap = await db.collection(CLOUD_FEES_COLLECTION).doc(docId).get();
        if (!snap.exists) return { ok: false, reason: "not_found" };
        const data = snap.data();
        const fees = Array.isArray(data.fees) ? data.fees : [];
        return { ok: true, fees };
      } catch (error) {
        console.error("Cloud load fees error:", error);
        return { ok: false, error };
      }
    }

    const CLASS_KEY_PREFIX = "psh_class_";
    const ATT_KEY_PREFIX = "psh_attendance_";
    const GRADES_KEY_PREFIX = "psh_grades_";
    const FEES_KEY_PREFIX = "psh_fees_";
    const PIN_KEY = "psh_pin_v1";

    const navAttendanceBtn = document.getElementById("navAttendance");
    const navGradesBtn = document.getElementById("navGrades");
    const navFeesBtn = document.getElementById("navFees");
    const navParentBtn = document.getElementById("navParent");
    const attendanceSection = document.getElementById("attendance");
    const gradesSection = document.getElementById("grades");
    const feesSection = document.getElementById("fees");
    const parentSection = document.getElementById("parent");

    const classNameEl = document.getElementById("className");
    const attDateEl = document.getElementById("attDate");
    const studentsRawEl = document.getElementById("studentsRaw");
    const classInfoEl = document.getElementById("classInfo");
    const studentsCountInfoEl = document.getElementById("studentsCountInfo");
    const attendanceTableBody = document.querySelector("#attendanceTable tbody");
    const attendanceSummaryEl = document.getElementById("attendanceSummary");
    const saveClassBtn = document.getElementById("saveClassBtn");
    const loadClassBtn = document.getElementById("loadClassBtn");
    const clearClassBtn = document.getElementById("clearClassBtn");
    const saveAttendanceBtn = document.getElementById("saveAttendanceBtn");
    const loadAttendanceBtn = document.getElementById("loadAttendanceBtn");
    const exportAttendanceBtn = document.getElementById("exportAttendanceBtn");

    const gradesClassNameEl = document.getElementById("gradesClassName");
    const subjectNameEl = document.getElementById("subjectName");
    const assessmentNameEl = document.getElementById("assessmentName");
    const maxScoreEl = document.getElementById("maxScore");
    const gradesLoadClassBtn = document.getElementById("gradesLoadClassBtn");
    const gradesLoadGradesBtn = document.getElementById("gradesLoadGradesBtn");
    const gradesClearScoresBtn = document.getElementById("gradesClearScoresBtn");
    const gradesSaveBtn = document.getElementById("gradesSaveBtn");
    const gradesExportBtn = document.getElementById("gradesExportBtn");
    const gradesInfoEl = document.getElementById("gradesInfo");
    const gradesSummaryEl = document.getElementById("gradesSummary");
    const gradesTableBody = document.querySelector("#gradesTable tbody");

    const feesClassNameEl = document.getElementById("feesClassName");
    const feePeriodEl = document.getElementById("feePeriod");
    const feesLoadClassBtn = document.getElementById("feesLoadClassBtn");
    const feesLoadDataBtn = document.getElementById("feesLoadDataBtn");
    const feesClearAmountsBtn = document.getElementById("feesClearAmountsBtn");
    const feesSaveBtn = document.getElementById("feesSaveBtn");
    const feesExportBtn = document.getElementById("feesExportBtn");
    const feesInfoEl = document.getElementById("feesInfo");
    const feesSummaryEl = document.getElementById("feesSummary");
    const feesTableBody = document.querySelector("#feesTable tbody");

    const parentClassNameEl = document.getElementById("parentClassName");
    const parentStudentSelectEl = document.getElementById("parentStudentSelect");
    const parentLoadClassBtn = document.getElementById("parentLoadClassBtn");
    const parentLoadDataBtn = document.getElementById("parentLoadDataBtn");
    const parentInfoEl = document.getElementById("parentInfo");
    const parentAttendanceListEl = document.getElementById("parentAttendanceList");
    const parentGradesListEl = document.getElementById("parentGradesList");
    const parentFeesListEl = document.getElementById("parentFeesList");

    const authStatusEl = document.getElementById("authStatus");
    const showAuthFormBtn = document.getElementById("showAuthFormBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authFormEl = document.getElementById("authForm");
    const authEmailEl = document.getElementById("authEmail");
    const authPasswordEl = document.getElementById("authPassword");
    const authSignInBtn = document.getElementById("authSignInBtn");
    const authSignUpBtn = document.getElementById("authSignUpBtn");
    const authMessageEl = document.getElementById("authMessage");

    const lockScreenEl = document.getElementById("lockScreen");
    const lockTitleEl = document.getElementById("lockTitle");
    const lockSubtitleEl = document.getElementById("lockSubtitle");
    const lockPinInputEl = document.getElementById("lockPinInput");
    const lockPrimaryBtnEl = document.getElementById("lockPrimaryBtn");
    const lockResetBtnEl = document.getElementById("lockResetBtn");
    const lockMessageEl = document.getElementById("lockMessage");

    const backupDownloadBtn = document.getElementById("backupDownloadBtn");
    const backupRestoreBtn = document.getElementById("backupRestoreBtn");
    const backupFileInput = document.getElementById("backupFileInput");
    const backupInfoEl = document.getElementById("backupInfo");

    let appInitialized = false;
    let savedPin = null;
    let isUnlockMode = false;

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function storageKeyForClass(className) {
      return CLASS_KEY_PREFIX + normalizeKey(className);
    }
    function storageKeyForAttendance(className, dateISO) {
      return ATT_KEY_PREFIX + normalizeKey(className) + "_" + dateISO;
    }
    function storageKeyForGrades(className, subject, assessment) {
      return GRADES_KEY_PREFIX +
        normalizeKey(className) + "_" +
        normalizeKey(subject) + "_" +
        normalizeKey(assessment);
    }
    function storageKeyForFees(className, period) {
      return FEES_KEY_PREFIX +
        normalizeKey(className) + "_" +
        normalizeKey(period);
    }
    function prettyFromKeyPart(str) {
      return str
        .split("_")
        .filter(Boolean)
        .map(s => s.charAt(0).toUpperCase() + s.slice(1))
        .join(" ");
    }
    function parseStudents(rawText) {
      const lines = rawText.split("\n");
      const students = [];
      for (let line of lines) {
        let name = line.trim();
        if (!name) continue;
        name = name.replace(/^\d+[\).\-\s]*/, "");
        if (!name) continue;
        students.push(name);
      }
      return students;
    }

    function toggleAuthForm() {
      if (authFormEl.style.display === "none" || authFormEl.style.display === "") {
        authFormEl.style.display = "block";
      } else {
        authFormEl.style.display = "none";
      }
      authMessageEl.textContent = "";
      authMessageEl.className = "auth-message";
    }

    function updateAuthUI(user) {
      if (user) {
        authStatusEl.textContent = `Signed in as ${user.email}`;
        logoutBtn.style.display = "inline-block";
        showAuthFormBtn.textContent = "Change account";
        authFormEl.style.display = "none";
        authMessageEl.textContent = "";
        authMessageEl.className = "auth-message";
      } else {
        authStatusEl.textContent = "Not signed in";
        logoutBtn.style.display = "none";
        showAuthFormBtn.textContent = "Sign in / Sign up";
      }
    }

    function handleSignIn() {
      const email = authEmailEl.value.trim();
      const password = authPasswordEl.value.trim();
      authMessageEl.textContent = "";
      authMessageEl.className = "auth-message";
      if (!email || !password) {
        authMessageEl.textContent = "Please enter both email and password.";
        authMessageEl.classList.add("error");
        return;
      }
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          authMessageEl.textContent = "Signed in successfully.";
          authMessageEl.classList.add("success");
        })
        .catch((error) => {
          authMessageEl.textContent = error.message;
          authMessageEl.classList.add("error");
        });
    }

    function handleSignUp() {
      const email = authEmailEl.value.trim();
      const password = authPasswordEl.value.trim();
      authMessageEl.textContent = "";
      authMessageEl.className = "auth-message";
      if (!email || !password) {
        authMessageEl.textContent = "Please enter both email and password.";
        authMessageEl.classList.add("error");
        return;
      }
      if (password.length < 6) {
        authMessageEl.textContent = "Password should be at least 6 characters.";
        authMessageEl.classList.add("error");
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => {
          authMessageEl.textContent = "Account created and signed in.";
          authMessageEl.classList.add("success");
        })
        .catch((error) => {
          authMessageEl.textContent = error.message;
          authMessageEl.classList.add("error");
        });
    }

    function handleLogout() {
      auth.signOut()
        .then(() => {
          authMessageEl.textContent = "Signed out.";
          authMessageEl.className = "auth-message success";
        })
        .catch((error) => {
          authMessageEl.textContent = error.message;
          authMessageEl.className = "auth-message error";
        });
    }

    async function loadClassList() {
      const className = classNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }

      classInfoEl.textContent = "Loading class list...";
      const localKey = storageKeyForClass(className);
      let students = null;

      if (auth.currentUser) {
        const cloudResult = await loadClassListFromCloud(className);
        if (cloudResult.ok && cloudResult.students.length > 0) {
          students = cloudResult.students;
          localStorage.setItem(localKey, JSON.stringify(students));
          classInfoEl.textContent = `Class list loaded from cloud and synced locally for "${className}".`;
        } else if (cloudResult.reason === "not_found") {
          classInfoEl.textContent = `No cloud class list found for "${className}". Trying local copy...`;
        } else if (!cloudResult.ok) {
          classInfoEl.textContent = "Could not load from cloud (rules/connection). Using local copy if available.";
        }
      } else {
        classInfoEl.textContent = "Not signed in. Using only local class list on this device.";
      }

      if (!students) {
        const saved = localStorage.getItem(localKey);
        if (saved) {
          students = JSON.parse(saved);
          classInfoEl.textContent += (students && students.length)
            ? ` Loaded ${students.length} students from local storage.`
            : " Local class list is empty.";
        } else {
          classInfoEl.textContent += " No class list found on this device.";
        }
      }

      if (!students || students.length === 0) {
        studentsRawEl.value = "";
        studentsCountInfoEl.textContent = "";
        attendanceTableBody.innerHTML = "";
        attendanceSummaryEl.textContent = "No students in this class yet.";
        return;
      }

      studentsRawEl.value = students.join("\n");
      studentsCountInfoEl.textContent = `Class list: ${students.length} students.`;
      buildAttendanceTable(students);
    }

    async function saveClassList() {
      const className = classNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      const students = parseStudents(studentsRawEl.value);
      if (students.length === 0) {
        alert("Please enter at least one student.");
        return;
      }
      const key = storageKeyForClass(className);
      localStorage.setItem(key, JSON.stringify(students));
      studentsCountInfoEl.textContent = `${students.length} students saved locally.`;
      classInfoEl.textContent = `Class list saved locally for "${className}".`;
      buildAttendanceTable(students);

      if (auth.currentUser) {
        classInfoEl.textContent += " Saving to cloud...";
        const cloudResult = await saveClassListToCloud(className, students);
        if (cloudResult.ok) {
          classInfoEl.textContent = `Class list saved locally and in cloud for "${className}".`;
        } else {
          classInfoEl.textContent = `Class list saved locally for "${className}". Cloud save failed (check rules/connection).`;
        }
      } else {
        classInfoEl.textContent += " Sign in if you want a cloud backup.";
      }
    }

    function clearClassList() {
      const className = classNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      const key = storageKeyForClass(className);
      if (!localStorage.getItem(key)) {
        alert("No class list found for this name on this device.");
        return;
      }
      if (!confirm(`Delete the local class list for "${className}" from this device? (Cloud data will stay.)`)) return;
      localStorage.removeItem(key);
      studentsRawEl.value = "";
      studentsCountInfoEl.textContent = "";
      attendanceTableBody.innerHTML = "";
      attendanceSummaryEl.textContent = "";
      classInfoEl.textContent = `Local class list deleted for "${className}". Cloud copy (if any) is not affected.`;
    }

    function buildAttendanceTable(students, existingStatuses = null) {
      attendanceTableBody.innerHTML = "";
      if (!students || students.length === 0) {
        attendanceSummaryEl.textContent = "No students in this class yet.";
        return;
      }
      students.forEach((name, index) => {
        const tr = document.createElement("tr");
        const tdIndex = document.createElement("td");
        tdIndex.textContent = index + 1;
        const tdName = document.createElement("td");
        tdName.textContent = name;
        const tdStatus = document.createElement("td");
        const select = document.createElement("select");
        select.className = "status-select";
        ["Present", "Absent", "Late"].forEach((status) => {
          const opt = document.createElement("option");
          opt.value = status;
          opt.textContent = status;
          select.appendChild(opt);
        });
        if (existingStatuses && existingStatuses[name]) {
          select.value = existingStatuses[name];
        } else {
          select.value = "Present";
        }
        tdStatus.appendChild(select);
        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdStatus);
        attendanceTableBody.appendChild(tr);
      });
      updateAttendanceSummary();
    }

    function getCurrentAttendanceFromTable() {
      const rows = attendanceTableBody.querySelectorAll("tr");
      const result = [];
      rows.forEach((tr) => {
        const nameCell = tr.children[1];
        const selectCell = tr.children[2];
        const name = nameCell.textContent.trim();
        const select = selectCell.querySelector("select");
        const status = select ? select.value : "Present";
        result.push({ name, status });
      });
      return result;
    }

    async function saveAttendance() {
      const className = classNameEl.value.trim();
      const dateVal = attDateEl.value;
      if (!className) { alert("Please select the class."); return; }
      if (!dateVal) { alert("Please select the date."); return; }
      const students = parseStudents(studentsRawEl.value);
      if (students.length === 0) {
        alert("Please save a class list first.");
        return;
      }
      const attendance = getCurrentAttendanceFromTable();
      const key = storageKeyForAttendance(className, dateVal);
      localStorage.setItem(key, JSON.stringify(attendance));
      updateAttendanceSummary();

      let msg = `Attendance saved locally for ${className} on ${dateVal}.`;
      attendanceSummaryEl.textContent = attendanceSummaryEl.textContent + " (Saved locally)";

      if (auth.currentUser) {
        const cloudResult = await saveAttendanceToCloud(className, dateVal, attendance);
        if (cloudResult.ok) {
          msg += " Attendance also saved in cloud.";
        } else {
          msg += " Cloud save failed (rules/connection).";
        }
      } else {
        msg += " Sign in if you want to sync across devices.";
      }
      alert(msg);
    }

    async function loadAttendanceForDate() {
      const className = classNameEl.value.trim();
      const dateVal = attDateEl.value;
      if (!className) { alert("Please select the class."); return; }
      if (!dateVal) { alert("Please select the date."); return; }

      const classKey = storageKeyForClass(className);
      const classSaved = localStorage.getItem(classKey);
      if (!classSaved) {
        alert("No class list found. Save the class list first.");
        return;
      }
      const students = JSON.parse(classSaved);
      let attendanceArr = null;

      if (auth.currentUser) {
        const cloudResult = await loadAttendanceFromCloud(className, dateVal);
        if (cloudResult.ok && cloudResult.attendance.length > 0) {
          attendanceArr = cloudResult.attendance;
          attendanceSummaryEl.textContent = `Attendance loaded from cloud for ${className} on ${dateVal}.`;
          const key = storageKeyForAttendance(className, dateVal);
          localStorage.setItem(key, JSON.stringify(attendanceArr));
        } else if (cloudResult.reason === "not_found") {
          attendanceSummaryEl.textContent = `No cloud attendance found for ${className} on ${dateVal}. Trying local...`;
        } else if (!cloudResult.ok) {
          attendanceSummaryEl.textContent = "Could not load attendance from cloud (rules/connection). Using local if available.";
        }
      } else {
        attendanceSummaryEl.textContent = "Not signed in. Using only local attendance on this device.";
      }

      if (!attendanceArr) {
        const key = storageKeyForAttendance(className, dateVal);
        const savedAtt = localStorage.getItem(key);
        if (!savedAtt) {
          alert("No attendance saved for this date yet. Table will use default (Present).");
          buildAttendanceTable(students);
          return;
        }
        attendanceArr = JSON.parse(savedAtt);
      }

      const statusMap = {};
      attendanceArr.forEach((item) => { statusMap[item.name] = item.status; });
      buildAttendanceTable(students, statusMap);
      updateAttendanceSummary();
    }

    function updateAttendanceSummary() {
      const attendance = getCurrentAttendanceFromTable();
      let present = 0, absent = 0, late = 0;
      attendance.forEach((item) => {
        if (item.status === "Present") present++;
        else if (item.status === "Absent") absent++;
        else if (item.status === "Late") late++;
      });
      const total = attendance.length;
      if (total === 0) {
        attendanceSummaryEl.textContent = "No attendance data yet.";
        return;
      }
      attendanceSummaryEl.textContent =
        `Total students: ${total} | Present: ${present} | Absent: ${absent} | Late: ${late}`;
    }

    function exportAttendanceCSV() {
      const className = classNameEl.value.trim();
      const dateVal = attDateEl.value;
      if (!className) { alert("Please select the class."); return; }
      if (!dateVal) { alert("Please select the date."); return; }
      const attendance = getCurrentAttendanceFromTable();
      if (attendance.length === 0) {
        alert("No attendance data to export.");
        return;
      }
      const header = ["Class", "Date", "Student name", "Status"];
      const rows = attendance.map(item => [
        className, dateVal, item.name, item.status
      ]);
      const csvContent = [header, ...rows]
        .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(","))
        .join("\r\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `attendance_${className.replace(/\s+/g, "_")}_${dateVal}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadClassForGrades() {
      const className = gradesClassNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      const key = storageKeyForClass(className);
      const saved = localStorage.getItem(key);
      if (!saved) {
        gradesInfoEl.textContent = "No class list found for this class. Please create it in the Attendance tab.";
        gradesTableBody.innerHTML = "";
        gradesSummaryEl.textContent = "";
        return;
      }
      const students = JSON.parse(saved);
      gradesInfoEl.textContent = `Class list loaded for "${className}" – ${students.length} students.`;
      buildGradesTable(students);
    }

    function buildGradesTable(students, existingScores = null) {
      gradesTableBody.innerHTML = "";
      if (!students || students.length === 0) {
        gradesSummaryEl.textContent = "No students to show. Load a class list first.";
        return;
      }
      students.forEach((name, index) => {
        const tr = document.createElement("tr");
        const tdIndex = document.createElement("td");
        tdIndex.textContent = index + 1;
        const tdName = document.createElement("td");
        tdName.textContent = name;
        const tdScore = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.className = "grade-input";
        input.min = "0";
        if (maxScoreEl.value) input.max = maxScoreEl.value;
        if (existingScores && Object.prototype.hasOwnProperty.call(existingScores, name)) {
          input.value = existingScores[name];
        }
        tdScore.appendChild(input);
        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdScore);
        gradesTableBody.appendChild(tr);
      });
      updateGradesSummary();
    }

    function getCurrentGradesFromTable() {
      const rows = gradesTableBody.querySelectorAll("tr");
      const result = [];
      rows.forEach((tr) => {
        const nameCell = tr.children[1];
        const scoreCell = tr.children[2];
        const name = nameCell.textContent.trim();
        const input = scoreCell.querySelector("input");
        let score = null;
        if (input && input.value !== "") {
          const n = parseFloat(input.value);
          if (!isNaN(n)) score = n;
        }
        result.push({ name, score });
      });
      return result;
    }

    function saveGrades() {
      const className = gradesClassNameEl.value.trim();
      const subject = subjectNameEl.value.trim();
      const assessment = assessmentNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      if (!subject) { alert("Please enter the subject."); return; }
      if (!assessment) { alert("Please enter the assessment name."); return; }

      const rows = gradesTableBody.querySelectorAll("tr");
      if (rows.length === 0) {
        alert("No students in the table. Load the class list first.");
        return;
      }

      const grades = getCurrentGradesFromTable();
      const hasAnyScore = grades.some(g => g.score !== null);
      if (!hasAnyScore) {
        const proceed = confirm("No scores entered. Save anyway?");
        if (!proceed) return;
      }

      const maxScore = maxScoreEl.value ? parseFloat(maxScoreEl.value) : null;
      const key = storageKeyForGrades(className, subject, assessment);
      const payload = { grades, maxScore };
      localStorage.setItem(key, JSON.stringify(payload));
      updateGradesSummary();
      alert(`Grades saved for ${className} – ${subject} – ${assessment}.`);
      gradesInfoEl.textContent = `Saved grades for "${className}" – ${subject} – ${assessment}.`;
    }

    function loadGrades() {
      const className = gradesClassNameEl.value.trim();
      const subject = subjectNameEl.value.trim();
      const assessment = assessmentNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      if (!subject) { alert("Please enter the subject."); return; }
      if (!assessment) { alert("Please enter the assessment name."); return; }

      const classKey = storageKeyForClass(className);
      const classSaved = localStorage.getItem(classKey);
      if (!classSaved) {
        alert("No class list found. Please create it in the Attendance tab first.");
        return;
      }
      const students = JSON.parse(classSaved);

      const key = storageKeyForGrades(className, subject, assessment);
      const saved = localStorage.getItem(key);
      if (!saved) {
        alert("No grades found for this combination yet. Table will be empty.");
        buildGradesTable(students);
        gradesInfoEl.textContent = `No previous grades; starting fresh for "${className}" – ${subject} – ${assessment}.`;
        return;
      }

      const payload = JSON.parse(saved);
      const gradesArr = payload.grades || [];
      const savedMax = payload.maxScore || null;
      if (savedMax !== null) maxScoreEl.value = savedMax;

      const scoreMap = {};
      gradesArr.forEach((g) => { scoreMap[g.name] = g.score; });
      buildGradesTable(students, scoreMap);
      gradesInfoEl.textContent = `Loaded grades for "${className}" – ${subject} – ${assessment}.`;
      updateGradesSummary();
    }

    function clearScores() {
      const rows = gradesTableBody.querySelectorAll("tr");
      if (rows.length === 0) {
        alert("No students loaded yet.");
        return;
      }
      if (!confirm("Clear all scores (students will remain)?")) return;
      rows.forEach((tr) => {
        const input = tr.children[2].querySelector("input");
        if (input) input.value = "";
      });
      updateGradesSummary();
    }

    function updateGradesSummary() {
      const grades = getCurrentGradesFromTable();
      const numericScores = grades
        .map(g => g.score)
        .filter(s => typeof s === "number" && !isNaN(s));

      const totalStudents = grades.length;
      const countWithScore = numericScores.length;

      if (totalStudents === 0) {
        gradesSummaryEl.textContent = "No students loaded yet.";
        return;
      }
      if (countWithScore === 0) {
        gradesSummaryEl.textContent =
          `Students: ${totalStudents} | No scores entered yet.`;
        return;
      }

      const sum = numericScores.reduce((a, b) => a + b, 0);
      const avg = sum / countWithScore;
      const min = Math.min(...numericScores);
      const max = Math.max(...numericScores);
      const maxScore = maxScoreEl.value ? parseFloat(maxScoreEl.value) : null;

      let text = `Students: ${totalStudents} | With score: ${countWithScore} | Average: ${avg.toFixed(2)} | Min: ${min} | Max: ${max}`;
      if (maxScore && maxScore > 0) {
        const avgPercent = (avg / maxScore) * 100;
        text += ` | Average: ${avgPercent.toFixed(1)}% of ${maxScore}`;
      }
      gradesSummaryEl.textContent = text;
    }

    function exportGradesCSV() {
      const className = gradesClassNameEl.value.trim();
      const subject = subjectNameEl.value.trim();
      const assessment = assessmentNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      if (!subject) { alert("Please enter the subject."); return; }
      if (!assessment) { alert("Please enter the assessment name."); return; }

      const grades = getCurrentGradesFromTable();
      if (grades.length === 0) {
        alert("No students in the table.");
        return;
      }

      const maxScore = maxScoreEl.value ? parseFloat(maxScoreEl.value) : null;
      const header = ["Class", "Subject", "Assessment", "Student name", "Score", "Max score"];
      const rows = grades.map(item => [
        className, subject, assessment,
        item.name,
        item.score !== null ? item.score : "",
        maxScore !== null ? maxScore : ""
      ]);
      const csvContent = [header, ...rows]
        .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(","))
        .join("\r\n");
      const safeClass = className.replace(/\s+/g, "_");
      const safeSubject = subject.replace(/\s+/g, "_");
      const safeAssessment = assessment.replace(/\s+/g, "_");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `grades_${safeClass}_${safeSubject}_${safeAssessment}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadClassForFees() {
      const className = feesClassNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      const key = storageKeyForClass(className);
      const saved = localStorage.getItem(key);
      if (!saved) {
        feesInfoEl.textContent = "No class list found for this class. Please create it in the Attendance tab.";
        feesTableBody.innerHTML = "";
        feesSummaryEl.textContent = "";
        return;
      }
      const students = JSON.parse(saved);
      feesInfoEl.textContent = `Class list loaded for "${className}" – ${students.length} students.`;
      buildFeesTable(students);
    }

    function buildFeesTable(students, existingData = null) {
      feesTableBody.innerHTML = "";
      if (!students || students.length === 0) {
        feesSummaryEl.textContent = "No students to show. Load a class list first.";
        return;
      }
      students.forEach((name, index) => {
        const tr = document.createElement("tr");
        const tdIndex = document.createElement("td");
        tdIndex.textContent = index + 1;
        const tdName = document.createElement("td");
        tdName.textContent = name;
        const tdTotal = document.createElement("td");
        const inputTotal = document.createElement("input");
        inputTotal.type = "number";
        inputTotal.className = "fee-input fee-total";
        inputTotal.min = "0";
        const tdPaid = document.createElement("td");
        const inputPaid = document.createElement("input");
        inputPaid.type = "number";
        inputPaid.className = "fee-input fee-paid";
        inputPaid.min = "0";
        const tdRemaining = document.createElement("td");
        tdRemaining.className = "fee-remaining";
        tdRemaining.textContent = "";

        if (existingData && existingData[name]) {
          const data = existingData[name];
          if (typeof data.total === "number") inputTotal.value = data.total;
          if (typeof data.paid === "number") inputPaid.value = data.paid;
        }

        inputTotal.addEventListener("input", () => updateFeesRowRemaining(tr));
        inputPaid.addEventListener("input", () => updateFeesRowRemaining(tr));

        tdTotal.appendChild(inputTotal);
        tdPaid.appendChild(inputPaid);
        tr.appendChild(tdIndex);
        tr.appendChild(tdName);
        tr.appendChild(tdTotal);
        tr.appendChild(tdPaid);
        tr.appendChild(tdRemaining);
        feesTableBody.appendChild(tr);
      });
      updateAllFeesRemaining();
      updateFeesSummary();
    }

    function updateFeesRowRemaining(tr) {
      const totalInput = tr.querySelector(".fee-total");
      const paidInput = tr.querySelector(".fee-paid");
      const remainingCell = tr.querySelector(".fee-remaining");
      const total = totalInput && totalInput.value !== "" ? parseFloat(totalInput.value) : 0;
      const paid = paidInput && paidInput.value !== "" ? parseFloat(paidInput.value) : 0;
      if (isNaN(total) || isNaN(paid)) {
        remainingCell.textContent = "";
        return;
      }
      const remaining = total - paid;
      remainingCell.textContent = remaining.toFixed(2);
      updateFeesSummary();
    }

    function updateAllFeesRemaining() {
      const rows = feesTableBody.querySelectorAll("tr");
      rows.forEach((tr) => updateFeesRowRemaining(tr));
    }

    function getCurrentFeesFromTable() {
      const rows = feesTableBody.querySelectorAll("tr");
      const result = [];
      rows.forEach((tr) => {
        const nameCell = tr.children[1];
        const totalInput = tr.querySelector(".fee-total");
        const paidInput = tr.querySelector(".fee-paid");
        const name = nameCell.textContent.trim();
        let total = null;
        let paid = null;
        if (totalInput && totalInput.value !== "") {
          const n = parseFloat(totalInput.value);
          if (!isNaN(n)) total = n;
        }
        if (paidInput && paidInput.value !== "") {
          const p = parseFloat(paidInput.value);
          if (!isNaN(p)) paid = p;
        }
        result.push({ name, total, paid });
      });
      return result;
    }

    async function saveFees() {
      const className = feesClassNameEl.value.trim();
      const period = feePeriodEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      if (!period) { alert("Please enter the fee period / term."); return; }

      const rows = feesTableBody.querySelectorAll("tr");
      if (rows.length === 0) {
        alert("No students in the table. Load the class list first.");
        return;
      }

      const fees = getCurrentFeesFromTable();
      const hasAnyData = fees.some(f => f.total !== null || f.paid !== null);
      if (!hasAnyData) {
        const proceed = confirm("No amounts entered. Save anyway?");
        if (!proceed) return;
      }

      const key = storageKeyForFees(className, period);
      const payload = { fees };
      localStorage.setItem(key, JSON.stringify(payload));
      updateFeesSummary();

      let msg = `Fees saved locally for ${className} – ${period}.`;
      feesInfoEl.textContent = `Fees saved locally for "${className}" – ${period}.`;

      if (auth.currentUser) {
        feesInfoEl.textContent += " Saving to cloud...";
        const cloudResult = await saveFeesToCloud(className, period, fees);
        if (cloudResult.ok) {
          feesInfoEl.textContent = `Fees saved locally and in cloud for "${className}" – ${period}.`;
          msg += " Fees also saved in cloud.";
        } else {
          feesInfoEl.textContent = `Fees saved locally for "${className}" – ${period}. Cloud save failed (rules/connection).`;
          msg += " Cloud save failed (rules/connection).";
        }
      } else {
        feesInfoEl.textContent += " Sign in if you want cloud backup and multi-device access.";
        msg += " Sign in if you want to sync across devices.";
      }
      alert(msg);
    }

    async function loadFeesData() {
      const className = feesClassNameEl.value.trim();
      const period = feePeriodEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      if (!period) { alert("Please enter the fee period / term."); return; }

      const classKey = storageKeyForClass(className);
      const classSaved = localStorage.getItem(classKey);
      if (!classSaved) {
        alert("No class list found. Please create it in the Attendance tab first.");
        return;
      }
      const students = JSON.parse(classSaved);
      let feesArr = null;

      if (auth.currentUser) {
        const cloudResult = await loadFeesFromCloud(className, period);
        if (cloudResult.ok && cloudResult.fees.length > 0) {
          feesArr = cloudResult.fees;
          feesInfoEl.textContent = `Fees loaded from cloud for "${className}" – ${period}.`;
          const key = storageKeyForFees(className, period);
          localStorage.setItem(key, JSON.stringify({ fees: feesArr }));
        } else if (cloudResult.reason === "not_found") {
          feesInfoEl.textContent = `No cloud fees found for "${className}" – ${period}. Trying local...`;
        } else if (!cloudResult.ok) {
          feesInfoEl.textContent = "Could not load fees from cloud (rules/connection). Using local copy if available.";
        }
      } else {
        feesInfoEl.textContent = "Not signed in. Using only local fees on this device.";
      }

      if (!feesArr) {
        const key = storageKeyForFees(className, period);
        const saved = localStorage.getItem(key);
        if (!saved) {
          alert("No fees data found for this class & period yet. Table will start empty.");
          buildFeesTable(students);
          feesInfoEl.textContent += ` No previous fees; starting fresh for "${className}" – ${period}.`;
          return;
        }
        const payload = JSON.parse(saved);
        feesArr = payload.fees || [];
        feesInfoEl.textContent += ` Loaded fees from local storage for "${className}" – ${period}.`;
      }

      const dataMap = {};
      feesArr.forEach((f) => {
        dataMap[f.name] = { total: f.total, paid: f.paid };
      });
      buildFeesTable(students, dataMap);
      updateFeesSummary();
    }

    function clearFeesAmounts() {
      const rows = feesTableBody.querySelectorAll("tr");
      if (rows.length === 0) {
        alert("No students loaded yet.");
        return;
      }
      if (!confirm("Clear all fee amounts (students will remain)?")) return;
      rows.forEach((tr) => {
        const totalInput = tr.querySelector(".fee-total");
        const paidInput = tr.querySelector(".fee-paid");
        const remainingCell = tr.querySelector(".fee-remaining");
        if (totalInput) totalInput.value = "";
        if (paidInput) paidInput.value = "";
        if (remainingCell) remainingCell.textContent = "";
      });
      updateFeesSummary();
    }

    function updateFeesSummary() {
      const fees = getCurrentFeesFromTable();
      if (fees.length === 0) {
        feesSummaryEl.textContent = "No students loaded yet.";
        return;
      }
      let totalFeeSum = 0;
      let totalPaidSum = 0;
      let totalRemainSum = 0;
      let countWithTotal = 0;
      let countWithPaid = 0;

      fees.forEach((f) => {
        if (typeof f.total === "number") {
          totalFeeSum += f.total;
          countWithTotal++;
        }
        if (typeof f.paid === "number") {
          totalPaidSum += f.paid;
          countWithPaid++;
        }
      });

      totalRemainSum = totalFeeSum - totalPaidSum;
      let text =
        `Students: ${fees.length} | Total fee set (sum): ${totalFeeSum.toFixed(2)} | Total paid (sum): ${totalPaidSum.toFixed(2)} | Remaining (sum): ${totalRemainSum.toFixed(2)}`;
      if (countWithTotal === 0 && countWithPaid === 0) {
        text = `Students: ${fees.length} | No fee amounts entered yet.`;
      }
      feesSummaryEl.textContent = text;
    }

    function exportFeesCSV() {
      const className = feesClassNameEl.value.trim();
      const period = feePeriodEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      if (!period) { alert("Please enter the fee period / term."); return; }

      const fees = getCurrentFeesFromTable();
      if (fees.length === 0) {
        alert("No students in the table.");
        return;
      }
      const header = ["Class", "Period", "Student name", "Total fee", "Paid", "Remaining"];
      const rows = fees.map(item => {
        const total = typeof item.total === "number" ? item.total : "";
        const paid = typeof item.paid === "number" ? item.paid : "";
        const remaining = (typeof item.total === "number" && typeof item.paid === "number")
          ? (item.total - item.paid).toFixed(2)
          : "";
        return [className, period, item.name, total, paid, remaining];
      });
      const csvContent = [header, ...rows]
        .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(","))
        .join("\r\n");
      const safeClass = className.replace(/\s+/g, "_");
      const safePeriod = period.replace(/\s+/g, "_");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `fees_${safeClass}_${safePeriod}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadClassForParent() {
      const className = parentClassNameEl.value.trim();
      if (!className) { alert("Please select the class."); return; }
      const key = storageKeyForClass(className);
      const saved = localStorage.getItem(key);
      if (!saved) {
        parentInfoEl.textContent = "No class list found for this class. Please create it in the Attendance tab.";
        parentStudentSelectEl.innerHTML = '<option value="">-- No students --</option>';
        parentAttendanceListEl.textContent = "";
        parentGradesListEl.textContent = "";
        parentFeesListEl.textContent = "";
        return;
      }
      const students = JSON.parse(saved);
      parentStudentSelectEl.innerHTML = "";
      students.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        parentStudentSelectEl.appendChild(opt);
      });
      parentInfoEl.textContent = `Loaded ${students.length} students for "${className}". Select one and click "Load student data".`;
    }

    function loadParentData() {
      const className = parentClassNameEl.value.trim();
      const studentName = parentStudentSelectEl.value;
      if (!className) { alert("Please select the class."); return; }
      if (!studentName) { alert("Please select a student."); return; }

      const classLower = normalizeKey(className);
      parentInfoEl.textContent = `Summary for ${studentName} in "${className}".`;
      parentAttendanceListEl.innerHTML = "";
      parentGradesListEl.innerHTML = "";
      parentFeesListEl.innerHTML = "";

      const attPrefix = ATT_KEY_PREFIX + classLower + "_";
      const attItems = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith(attPrefix)) continue;
        const datePart = key.substring(attPrefix.length);
        try {
          const records = JSON.parse(localStorage.getItem(key));
          const match = records.find(r => r.name === studentName);
          if (match) {
            attItems.push({ date: datePart, status: match.status });
          }
        } catch (e) {}
      }
      attItems.sort((a, b) => a.date.localeCompare(b.date));
      if (attItems.length === 0) {
        parentAttendanceListEl.textContent = "No attendance records found for this student.";
      } else {
        const ul = document.createElement("ul");
        ul.style.paddingLeft = "18px";
        attItems.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `${item.date}: ${item.status}`;
          ul.appendChild(li);
        });
        parentAttendanceListEl.appendChild(ul);
      }

      const gradesPrefix = GRADES_KEY_PREFIX + classLower + "_";
      const gradeItems = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith(gradesPrefix)) continue;
        const rest = key.substring(gradesPrefix.length);
        const parts = rest.split("_");
        if (parts.length < 2) continue;
        const subjectLower = parts[0];
        const assessmentLower = parts.slice(1).join("_");
        try {
          const payload = JSON.parse(localStorage.getItem(key));
          const arr = (payload && payload.grades) || [];
          const maxScore = payload && typeof payload.maxScore === "number" ? payload.maxScore : null;
          const match = arr.find(g => g.name === studentName);
          if (match && typeof match.score === "number") {
            gradeItems.push({
              subject: prettyFromKeyPart(subjectLower),
              assessment: prettyFromKeyPart(assessmentLower),
              score: match.score,
              maxScore: maxScore
            });
          }
        } catch (e) {}
      }
      if (gradeItems.length === 0) {
        parentGradesListEl.textContent = "No grades found for this student.";
      } else {
        const ul = document.createElement("ul");
        ul.style.paddingLeft = "18px";
        gradeItems.forEach(item => {
          const li = document.createElement("li");
          if (item.maxScore) {
            const percent = (item.score / item.maxScore) * 100;
            li.textContent = `${item.subject} – ${item.assessment}: ${item.score} / ${item.maxScore} (${percent.toFixed(1)}%)`;
          } else {
            li.textContent = `${item.subject} – ${item.assessment}: ${item.score}`;
          }
          ul.appendChild(li);
        });
        parentGradesListEl.appendChild(ul);
      }

      const feesPrefix = FEES_KEY_PREFIX + classLower + "_";
      const feeItems = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith(feesPrefix)) continue;
        const periodLower = key.substring(feesPrefix.length);
        try {
          const payload = JSON.parse(localStorage.getItem(key));
          const arr = (payload && payload.fees) || [];
          const match = arr.find(f => f.name === studentName);
          if (match) {
            const total = typeof match.total === "number" ? match.total : null;
            const paid = typeof match.paid === "number" ? match.paid : null;
            const remaining = (total !== null && paid !== null) ? (total - paid) : null;
            feeItems.push({
              period: prettyFromKeyPart(periodLower),
              total,
              paid,
              remaining
            });
          }
        } catch (e) {}
      }
      if (feeItems.length === 0) {
        parentFeesListEl.textContent = "No fees data found for this student.";
      } else {
        const ul = document.createElement("ul");
        ul.style.paddingLeft = "18px";
        feeItems.forEach(item => {
          const li = document.createElement("li");
          let text = `${item.period}: `;
          if (item.total !== null) text += `Total ${item.total.toFixed(2)}; `;
          if (item.paid !== null) text += `Paid ${item.paid.toFixed(2)}; `;
          if (item.remaining !== null) text += `Remaining ${item.remaining.toFixed(2)}`;
          li.textContent = text;
          ul.appendChild(li);
        });
        parentFeesListEl.appendChild(ul);
      }
    }

    function switchToAttendance() {
      navAttendanceBtn.classList.add("active");
      navGradesBtn.classList.remove("active");
      navFeesBtn.classList.remove("active");
      navParentBtn.classList.remove("active");
      attendanceSection.style.display = "block";
      gradesSection.style.display = "none";
      feesSection.style.display = "none";
      parentSection.style.display = "none";
    }
    function switchToGrades() {
      navGradesBtn.classList.add("active");
      navAttendanceBtn.classList.remove("active");
      navFeesBtn.classList.remove("active");
      navParentBtn.classList.remove("active");
      attendanceSection.style.display = "none";
      gradesSection.style.display = "block";
      feesSection.style.display = "none";
      parentSection.style.display = "none";
    }
    function switchToFees() {
      navFeesBtn.classList.add("active");
      navAttendanceBtn.classList.remove("active");
      navGradesBtn.classList.remove("active");
      navParentBtn.classList.remove("active");
      attendanceSection.style.display = "none";
      gradesSection.style.display = "none";
      feesSection.style.display = "block";
      parentSection.style.display = "none";
    }
    function switchToParent() {
      navParentBtn.classList.add("active");
      navAttendanceBtn.classList.remove("active");
      navGradesBtn.classList.remove("active");
      navFeesBtn.classList.remove("active");
      attendanceSection.style.display = "none";
      gradesSection.style.display = "none";
      feesSection.style.display = "none";
      parentSection.style.display = "block";
    }

    function createBackupJson() {
      const backup = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith("psh_")) {
          backup[key] = localStorage.getItem(key);
        }
      }
      if (Object.keys(backup).length === 0) {
        backupInfoEl.textContent = "No Private School Hub data found in this browser yet.";
        return null;
      }
      backupInfoEl.textContent = `Backup ready with ${Object.keys(backup).length} items.`;
      return JSON.stringify(backup, null, 2);
    }

    function downloadBackupFile() {
      const json = createBackupJson();
      if (!json) return;
      const blob = new Blob([json], { type: "application/json;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      a.href = url;
      a.download = `private_school_hub_backup_${y}${m}${d}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      backupInfoEl.textContent = "Backup file downloaded successfully. Keep it in a safe place.";
    }

    function restoreBackupData(data) {
      if (!data || typeof data !== "object") {
        backupInfoEl.textContent = "Invalid backup file.";
        return;
      }
      const confirmRestore = confirm(
        "Restoring a backup will overwrite existing Private School Hub data on this device. Continue?"
      );
      if (!confirmRestore) {
        backupInfoEl.textContent = "Restore cancelled.";
        return;
      }
      let count = 0;
      for (const key in data) {
        if (key.startsWith("psh_") && typeof data[key] === "string") {
          localStorage.setItem(key, data[key]);
          count++;
        }
      }
      backupInfoEl.textContent = `Backup restored: ${count} items written. The page will now reload.`;
      alert("Backup restored. The page will reload to apply changes.");
      location.reload();
    }

    function loadPin() { savedPin = localStorage.getItem(PIN_KEY); }

    function showLockScreen() {
      loadPin();
      lockScreenEl.style.display = "flex";
      if (savedPin) {
        isUnlockMode = true;
        lockTitleEl.textContent = "Enter your PIN";
        lockSubtitleEl.textContent = "This protects your Private School Hub data on this device.";
        lockPrimaryBtnEl.textContent = "Unlock";
        lockResetBtnEl.style.display = "inline-block";
      } else {
        isUnlockMode = false;
        lockTitleEl.textContent = "Set your 4-digit PIN";
        lockSubtitleEl.textContent = "This PIN will protect your Private School Hub data on this device.";
        lockPrimaryBtnEl.textContent = "Save PIN";
        lockResetBtnEl.style.display = "none";
      }
      lockPinInputEl.value = "";
      lockMessageEl.textContent = "";
      setTimeout(() => lockPinInputEl.focus(), 50);
    }

    function hideLockScreen() { lockScreenEl.style.display = "none"; }

    function handleLockPrimary() {
      const pin = lockPinInputEl.value.trim();
      if (pin.length !== 4) {
        lockMessageEl.textContent = "PIN must be 4 digits.";
        return;
      }
      if (!/^\d{4}$/.test(pin)) {
        lockMessageEl.textContent = "Use only numbers.";
        return;
      }
      if (!isUnlockMode) {
        localStorage.setItem(PIN_KEY, pin);
        savedPin = pin;
        lockMessageEl.textContent = "";
        bootApp();
        hideLockScreen();
      } else {
        if (pin === savedPin) {
          lockMessageEl.textContent = "";
          bootApp();
          hideLockScreen();
        } else {
          lockMessageEl.textContent = "Incorrect PIN.";
        }
      }
    }

    function handleLockReset() {
      const sure = confirm("This will erase ALL Private School Hub data and PIN on this device. Continue?");
      if (!sure) return;
      localStorage.clear();
      location.reload();
    }

    function initAppLogic() {
      attDateEl.value = todayISO();

      saveClassBtn.addEventListener("click", () => { saveClassList(); });
      loadClassBtn.addEventListener("click", () => { loadClassList(); });
      clearClassBtn.addEventListener("click", clearClassList);
      saveAttendanceBtn.addEventListener("click", () => { saveAttendance(); });
      loadAttendanceBtn.addEventListener("click", () => { loadAttendanceForDate(); });
      exportAttendanceBtn.addEventListener("click", exportAttendanceCSV);
      attendanceTableBody.addEventListener("change", (e) => {
        if (e.target.tagName === "SELECT") updateAttendanceSummary();
      });

      gradesLoadClassBtn.addEventListener("click", loadClassForGrades);
      gradesLoadGradesBtn.addEventListener("click", loadGrades);
      gradesClearScoresBtn.addEventListener("click", clearScores);
      gradesSaveBtn.addEventListener("click", saveGrades);
      gradesExportBtn.addEventListener("click", exportGradesCSV);
      gradesTableBody.addEventListener("input", (e) => {
        if (e.target.classList.contains("grade-input")) updateGradesSummary();
      });

      feesLoadClassBtn.addEventListener("click", loadClassForFees);
      feesLoadDataBtn.addEventListener("click", () => { loadFeesData(); });
      feesClearAmountsBtn.addEventListener("click", clearFeesAmounts);
      feesSaveBtn.addEventListener("click", () => { saveFees(); });
      feesExportBtn.addEventListener("click", exportFeesCSV);
      feesTableBody.addEventListener("input", (e) => {
        if (e.target.classList.contains("fee-input")) {
          updateAllFeesRemaining();
          updateFeesSummary();
        }
      });

      parentLoadClassBtn.addEventListener("click", loadClassForParent);
      parentLoadDataBtn.addEventListener("click", loadParentData);

      navAttendanceBtn.addEventListener("click", switchToAttendance);
      navGradesBtn.addEventListener("click", switchToGrades);
      navFeesBtn.addEventListener("click", switchToFees);
      navParentBtn.addEventListener("click", switchToParent);

      showAuthFormBtn.addEventListener("click", toggleAuthForm);
      authSignInBtn.addEventListener("click", handleSignIn);
      authSignUpBtn.addEventListener("click", handleSignUp);
      logoutBtn.addEventListener("click", handleLogout);

      auth.onAuthStateChanged((user) => { updateAuthUI(user); });

      backupDownloadBtn.addEventListener("click", downloadBackupFile);
      backupRestoreBtn.addEventListener("click", () => { backupFileInput.click(); });
      backupFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) {
          backupInfoEl.textContent = "No file selected.";
          return;
        }
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            restoreBackupData(data);
          } catch (err) {
            console.error("Backup restore error:", err);
            backupInfoEl.textContent = "Could not read backup file (invalid JSON).";
          }
        };
        reader.readAsText(file);
      });
    }

    function bootApp() {
      if (appInitialized) return;
      appInitialized = true;
      initAppLogic();
    }

    function init() {
      lockPrimaryBtnEl.addEventListener("click", handleLockPrimary);
      lockResetBtnEl.addEventListener("click", handleLockReset);
      lockPinInputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleLockPrimary();
      });
      showLockScreen();
    }

    init();
  </script>
</body>
</html>
